local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")

local WALK_SPEED = 15
local RUN_SPEED = 21
local STAMINA_MAX = 100
local STAMINA_THRESHOLD = 50
local STAMINA_DECREASE_RATE = 12
local STAMINA_INCREASE_RATE = 8
local STAMINA_LOW_RECOVER_RATE = 3
local SUBTITLE_DURATION = 5
local FADE_DURATION = 0.3
local isSprinting = false
local currentStamina = STAMINA_MAX
local exhaustionSubtitle = nil
local isSubtitleActive = false
local isStaminaLocked = false
local sprintButton = nil

local function createSubtitle()
    local gui = Instance.new("ScreenGui")
    gui.Name = "SubtitleUI"
    gui.Parent = player.PlayerGui

    exhaustionSubtitle = Instance.new("TextLabel")
    exhaustionSubtitle.Size = UDim2.new(0.4, 0, 0.1, 0)
    exhaustionSubtitle.Position = UDim2.new(0.3, 0, 0.6, 0)
    exhaustionSubtitle.BackgroundTransparency = 1
    exhaustionSubtitle.Text = "You're exhausted"
    exhaustionSubtitle.TextColor3 = Color3.new(1, 0.2, 0.2)
    exhaustionSubtitle.TextSize = 32
    exhaustionSubtitle.Font = Enum.Font.SourceSansBold
    exhaustionSubtitle.TextTransparency = 1
    exhaustionSubtitle.ZIndex = 10000
    exhaustionSubtitle.Parent = gui
end

local function showSubtitle()
    if isSubtitleActive then return end
    isSubtitleActive = true
    TweenService:Create(exhaustionSubtitle, TweenInfo.new(FADE_DURATION), {TextTransparency = 0}):Play()
    task.spawn(function()
        wait(FADE_DURATION + SUBTITLE_DURATION)
        TweenService:Create(exhaustionSubtitle, TweenInfo.new(FADE_DURATION), {TextTransparency = 1}):Play()
        wait(FADE_DURATION)
        isSubtitleActive = false
    end)
end

local function createSprintUI()
    local gui = Instance.new("ScreenGui")
    gui.Name = "SprintUI"
    gui.Parent = player.PlayerGui

    local darkOverlay = Instance.new("Frame")
    darkOverlay.Size = UDim2.new(1, 0, 1, 0)
    darkOverlay.BackgroundColor3 = Color3.new(0, 0, 0)
    darkOverlay.BackgroundTransparency = 1
    darkOverlay.ZIndex = 999
    darkOverlay.Parent = gui

    sprintButton = Instance.new("TextButton")
    sprintButton.Size = UDim2.new(0.15, 0, 0.07, 0)
    sprintButton.Position = UDim2.new(0.8, 0, 0.5, 0)
    sprintButton.BackgroundColor3 = Color3.new(0.8, 0.6, 0.2)
    sprintButton.BorderSizePixel = 1
    sprintButton.Text = "Sprint"
    sprintButton.TextColor3 = Color3.new(0, 0, 0)
    sprintButton.TextSize = 20
    sprintButton.Font = Enum.Font.SourceSansBold
    sprintButton.ZIndex = 1000
    sprintButton.Parent = gui

    local staminaBarBg = Instance.new("Frame")
    staminaBarBg.Size = UDim2.new(0.3, 0, 0.02, 0)
    staminaBarBg.Position = UDim2.new(0.65, 0, 0.82, 0)
    staminaBarBg.BackgroundColor3 = Color3.new(0.3, 0.3, 0.3)
    staminaBarBg.ZIndex = 1000
    staminaBarBg.Parent = gui

    local staminaBar = Instance.new("Frame")
    staminaBar.Size = UDim2.new(1, 0, 1, 0)
    staminaBar.BackgroundColor3 = Color3.new(0.9, 0.8, 0.6)
    staminaBar.ZIndex = 1001
    staminaBar.Parent = staminaBarBg

    sprintButton.Activated:Connect(function()
        if isStaminaLocked then return end
        if currentStamina <= 0 then return end
        isSprinting = not isSprinting
        humanoid.WalkSpeed = isSprinting and RUN_SPEED or WALK_SPEED
        sprintButton.Text = isSprinting and "Running" or "Sprint"
        sprintButton.BackgroundColor3 = isSprinting and Color3.new(0.8, 0.6, 0.2) or Color3.new(0.3, 0.8, 0.4)
    end)

    return {
        UpdateStamina = function(stamina)
            currentStamina = stamina
            local newSize = UDim2.new(stamina / STAMINA_MAX, 0, 1, 0)
            TweenService:Create(staminaBar, TweenInfo.new(0.1), {Size = newSize}):Play()

            if isStaminaLocked and currentStamina >= STAMINA_THRESHOLD then
                isStaminaLocked = false
                sprintButton.BackgroundColor3 = Color3.new(0.3, 0.8, 0.4)
                sprintButton.Text = "Sprint"
                staminaBar.BackgroundColor3 = Color3.new(0.9, 0.8, 0.6)
                TweenService:Create(darkOverlay, TweenInfo.new(0.3), {BackgroundTransparency = 1}):Play()
            end

            if currentStamina == 0 and not isStaminaLocked then
                isStaminaLocked = true
                isSprinting = false
                humanoid.WalkSpeed = WALK_SPEED
                sprintButton.BackgroundColor3 = Color3.new(0.3, 0.3, 0.3)
                sprintButton.Text = "Locked"
                staminaBar.BackgroundColor3 = Color3.new(0.5, 0.5, 0.5)
                showSubtitle()
            end

            if currentStamina <= STAMINA_THRESHOLD and currentStamina > 0 and not isStaminaLocked then
                local targetTransparency = 0.8 - ((STAMINA_THRESHOLD - stamina) / STAMINA_THRESHOLD) * 0.5
                TweenService:Create(darkOverlay, TweenInfo.new(0.1), {BackgroundTransparency = targetTransparency}):Play()
            elseif currentStamina > STAMINA_THRESHOLD and not isStaminaLocked then
                TweenService:Create(darkOverlay, TweenInfo.new(0.15), {BackgroundTransparency = 1}):Play()
            end

            if isStaminaLocked then
                local exhaustionIntensity = 0.7 - (currentStamina / STAMINA_MAX) * 0.2
                TweenService:Create(darkOverlay, TweenInfo.new(0.2), {BackgroundTransparency = exhaustionIntensity}):Play()
            end
        end
    }
end

createSubtitle()
local sprintUI = createSprintUI()

player.CharacterAdded:Connect(function(newChar)
    character = newChar
    humanoid = character:WaitForChild("Humanoid")
    humanoid.WalkSpeed = WALK_SPEED
    isSprinting = false
    currentStamina = STAMINA_MAX
    isSubtitleActive = false
    isStaminaLocked = false
    
    if exhaustionSubtitle then
        exhaustionSubtitle.TextTransparency = 1
    end
    
    if sprintButton then
        sprintButton.Text = "Sprint"
        sprintButton.BackgroundColor3 = Color3.new(0.3, 0.8, 0.4)
    end
    
    sprintUI.UpdateStamina(currentStamina)
end)

RunService.Heartbeat:Connect(function(deltaTime)
    if isSprinting and currentStamina > 0 and not isStaminaLocked then
        currentStamina = math.max(0, currentStamina - STAMINA_DECREASE_RATE * deltaTime)
    else
        local recoverRate = currentStamina == 0 and STAMINA_LOW_RECOVER_RATE or STAMINA_INCREASE_RATE
        if currentStamina < STAMINA_MAX then
            currentStamina = math.min(STAMINA_MAX, currentStamina + recoverRate * deltaTime)
        end
    end
    sprintUI.UpdateStamina(currentStamina)
end)

humanoid.WalkSpeed = WALK_SPEED
